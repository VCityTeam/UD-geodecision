
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>geodecision.graph.connectpoints &#8212; geodecision 0.1.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for geodecision.graph.connectpoints</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Thu Sep 12 16:16:55 2019</span>

<span class="sd">Source: https://github.com/ywnch/toolbox (Yuwen Chang)</span>
<span class="sd">License of the source:</span>
<span class="sd">    MIT License</span>
<span class="sd">    </span>
<span class="sd">    Copyright (c) 2019 Yuwen</span>
<span class="sd">    </span>
<span class="sd">    Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="sd">    of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="sd">    in the Software without restriction, including without limitation the rights</span>
<span class="sd">    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="sd">    copies of the Software, and to permit persons to whom the Software is</span>
<span class="sd">    furnished to do so, subject to the following conditions:</span>
<span class="sd">    </span>
<span class="sd">    The above copyright notice and this permission notice shall be included in all</span>
<span class="sd">    copies or substantial portions of the Software.</span>
<span class="sd">    </span>
<span class="sd">    THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="sd">    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="sd">    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="sd">    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="sd">    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="sd">    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="sd">    SOFTWARE.</span>

<span class="sd">@adaptation: thomas</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">rtree</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="k">import</span> <span class="n">MultiPoint</span><span class="p">,</span> <span class="n">LineString</span>
<span class="kn">from</span> <span class="nn">shapely.ops</span> <span class="k">import</span> <span class="n">snap</span><span class="p">,</span> <span class="n">split</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">..logger.logger</span> <span class="k">import</span> <span class="n">logger</span>

<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">chained_assignment</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="ConnectPoints"><a class="viewcode-back" href="../../../geodecision.graph.html#geodecision.graph.connectpoints.ConnectPoints">[docs]</a><span class="k">class</span> <span class="nc">ConnectPoints</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description</span>
<span class="sd">    ------------</span>
<span class="sd">    </span>
<span class="sd">    Connect and integrate a set of POIs into an existing road network.</span>
<span class="sd">    Given a road network in the form of two GeoDataFrames: nodes and edges,</span>
<span class="sd">    link each POI to the nearest edge (road segment) based on its projection</span>
<span class="sd">    point (PP) and generate a new integrated road network including the POIs,</span>
<span class="sd">    the projected points, and the connection edge.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    </span>
<span class="sd">    - nodes (GeoDataFrame): the original gdf with POIs and PPs appended</span>
<span class="sd">    - edges (GeoDataFrame): the original gdf with connection edges appended</span>
<span class="sd">                          and existing edges updated (if PPs are present)</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    </span>
<span class="sd">    - pois (GeoDataFrame): </span>
<span class="sd">        - GDF of POI (geom: Point)</span>
<span class="sd">        - Must be in metric projection (same for nodes, pois and edges)</span>
<span class="sd">    - nodes (GeoDataFrame): </span>
<span class="sd">        - GDF of road network nodes (geom: Point)</span>
<span class="sd">        - Must be in metric projection (same for nodes, pois and edges)</span>
<span class="sd">    - edges (GeoDataFrame): </span>
<span class="sd">        - GDF of road network edges (geom: LineString)</span>
<span class="sd">        - Must be in metric projection (same for nodes, pois and edges)</span>
<span class="sd">    - access_type (str):</span>
<span class="sd">        - Type of polygon that have to be connected to the network</span>
<span class="sd">        - Ex: &quot;park&quot;, &quot;building&quot;, ...</span>
<span class="sd">    - prefix(str):</span>
<span class="sd">        - Prefix for the name of new nodes and edges files</span>
<span class="sd">        - Ex: &quot;Lyon_area_parks&quot; </span>
<span class="sd">    - key_col (str): </span>
<span class="sd">        - a unique key column of pois should be provided,</span>
<span class="sd">          e.g., &#39;index&#39;, &#39;osmid&#39;, &#39;poi_number&#39;, etc.</span>
<span class="sd">          Currently, this will be renamed into &#39;osmid&#39; in the output.</span>
<span class="sd">    - path (str): </span>
<span class="sd">        - directory path to use for saving files (nodes and edges).</span>
<span class="sd">    - threshold (int): </span>
<span class="sd">        - the max length (in meters) of a POI connection edge, POIs with</span>
<span class="sd">          connection edge beyond this length will be removed.</span>
<span class="sd">    - knn (int): </span>
<span class="sd">        - k nearest neighbors to query for the nearest edge.</span>
<span class="sd">          Consider increasing this number up to 10 if the connection</span>
<span class="sd">          output is slightly unreasonable. But higher knn number will</span>
<span class="sd">          slow down the process.</span>
<span class="sd">    - distance(int):</span>
<span class="sd">        - distance reachable in 60 minutes</span>
<span class="sd">        - required to measure the time distance of an edge</span>
<span class="sd">        - default: 5000 (meters)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">points</span><span class="p">,</span> 
            <span class="n">nodes</span><span class="p">,</span> 
            <span class="n">edges</span><span class="p">,</span>
            <span class="n">access_type</span><span class="p">,</span>
            <span class="n">prefix</span><span class="p">,</span>
            <span class="n">key_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">threshold</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> 
            <span class="n">knn</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">distance</span><span class="o">=</span><span class="mi">5000</span>
            <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="n">nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">=</span> <span class="n">edges</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">access_type</span> <span class="o">=</span> <span class="n">access_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key_col</span> <span class="o">=</span> <span class="n">key_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knn</span> <span class="o">=</span> <span class="n">knn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_highway_pp</span> <span class="o">=</span> <span class="s1">&#39;projected_pap&#39;</span>  <span class="c1"># Access Point</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_highway_access</span> <span class="o">=</span> <span class="s1">&#39;access&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edge_highway</span> <span class="o">=</span> <span class="s1">&#39;projected_footway&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">osmid_prefix</span> <span class="o">=</span> <span class="mi">9990000000</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">distance</span> <span class="o">=</span> <span class="n">distance</span>
        
        <span class="c1">#Build Rtree</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Rtree</span> <span class="o">=</span> <span class="n">rtree</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">Index</span><span class="p">()</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Rtree</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="n">fid</span><span class="p">,</span> 
                <span class="n">geom</span><span class="o">.</span><span class="n">bounds</span>
                <span class="p">)</span> <span class="k">for</span> <span class="n">fid</span><span class="p">,</span> <span class="n">geom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()];</span>
        
    
<div class="viewcode-block" id="ConnectPoints.update_nodes_process"><a class="viewcode-back" href="../../../geodecision.graph.html#geodecision.graph.connectpoints.ConnectPoints.update_nodes_process">[docs]</a>    <span class="k">def</span> <span class="nf">update_nodes_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        ------------</span>
<span class="sd">        </span>
<span class="sd">        Update the NetworkX Graph object with input nodes and nodes created</span>
<span class="sd">        during the splitting edges operation</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        </span>
<span class="sd">        None</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        </span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Update nodes with new access nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_nodes</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">,</span>
                <span class="n">ptype</span> <span class="o">=</span> <span class="s2">&quot;access&quot;</span>
                <span class="p">)</span>
        
        <span class="c1">#Update nodes with new created nodes (interpolated points)</span>
        <span class="c1"># locate nearest edge (kne) and projected point (pp)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="s1">&#39;near_idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">list</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Rtree</span><span class="o">.</span><span class="n">nearest</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">knn</span><span class="p">)</span>
                        <span class="p">)</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span>
                <span class="p">]</span>  <span class="c1"># slow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="s1">&#39;near_lines&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="n">near_idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">near_idx</span> <span class="ow">in</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="s1">&#39;near_idx&#39;</span><span class="p">]</span>
                                    <span class="p">]</span>  <span class="c1"># very slow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="s1">&#39;kne_idx&#39;</span><span class="p">],</span> <span class="n">knes</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="o">*</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">find_kne</span><span class="p">(</span>
                            <span class="n">point</span><span class="p">,</span> 
                            <span class="n">near_lines</span>
                            <span class="p">)</span> <span class="k">for</span> <span class="n">point</span><span class="p">,</span> <span class="n">near_lines</span> <span class="ow">in</span>
              <span class="nb">zip</span><span class="p">(</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span> 
                      <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="s1">&#39;near_lines&#39;</span><span class="p">]</span>
                      <span class="p">)</span>
              <span class="p">]</span>
            <span class="p">)</span>  <span class="c1"># slow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="s1">&#39;pp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_pp</span><span class="p">(</span>
                        <span class="n">point</span><span class="p">,</span> 
                        <span class="n">kne</span>
                        <span class="p">)</span> <span class="k">for</span> <span class="n">point</span><span class="p">,</span> <span class="n">kne</span> <span class="ow">in</span>
                            <span class="nb">zip</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span> 
                                    <span class="n">knes</span>
                                    <span class="p">)</span>
                            <span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_nodes</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> 
                <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="s1">&#39;pp&#39;</span><span class="p">]),</span>
                <span class="n">ptype</span><span class="o">=</span><span class="s1">&#39;pp&#39;</span>
                <span class="p">)</span>
        <span class="n">nodes_coord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes_id_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="nb">zip</span><span class="p">(</span>
                        <span class="n">nodes_coord</span><span class="p">,</span> 
                        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;osmid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
                        <span class="p">)</span>
                <span class="p">)</span></div>
                
<div class="viewcode-block" id="ConnectPoints.update_edges_process"><a class="viewcode-back" href="../../../geodecision.graph.html#geodecision.graph.connectpoints.ConnectPoints.update_edges_process">[docs]</a>    <span class="k">def</span> <span class="nf">update_edges_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        ------------</span>
<span class="sd">        </span>
<span class="sd">        Update the NetworkX Graph object with edges created</span>
<span class="sd">        during the splitting edges operation</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        </span>
<span class="sd">        None</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        </span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Update existing edges </span>
        <span class="c1">## Split edges to segments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line_pps_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">MultiPoint</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;kne_idx&#39;</span><span class="p">])[</span><span class="s1">&#39;pp&#39;</span><span class="p">]</span>
                     <span class="p">}</span>
        <span class="n">new_lines</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">split_line</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span> 
                        <span class="n">pps</span>
                        <span class="p">)</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">pps</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_pps_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>  <span class="c1"># bit slow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_edges</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span> 
                <span class="n">new_lines</span><span class="p">,</span> 
                <span class="n">replace</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
        <span class="c1"># Update external edges (projected footways connected to pois)</span>
        <span class="c1"># establish new_edges</span>
        <span class="n">pps_gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;highway&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_highway_pp</span><span class="p">]</span>
        <span class="n">new_lines</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">LineString</span><span class="p">([</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">])</span> <span class="k">for</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span> 
                        <span class="n">pps_gdf</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span>
                        <span class="p">)</span>
                <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_edges</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span> 
                <span class="n">new_lines</span><span class="p">,</span> 
                <span class="n">replace</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span></div>
        
<div class="viewcode-block" id="ConnectPoints.find_kne"><a class="viewcode-back" href="../../../geodecision.graph.html#geodecision.graph.connectpoints.ConnectPoints.find_kne">[docs]</a>    <span class="k">def</span> <span class="nf">find_kne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span>
                        <span class="nb">map</span><span class="p">(</span>
                                <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">point</span><span class="p">),</span> 
                                <span class="n">lines</span>
                                <span class="p">)</span>
                        <span class="p">)</span>
                <span class="p">)</span>
        <span class="n">kne_pos</span> <span class="o">=</span> <span class="n">dists</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">kne</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="n">kne_pos</span><span class="p">]]</span>
        <span class="n">kne_idx</span> <span class="o">=</span> <span class="n">kne</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">kne_idx</span><span class="p">,</span> <span class="n">kne</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>
    
<div class="viewcode-block" id="ConnectPoints.get_pp"><a class="viewcode-back" href="../../../geodecision.graph.html#geodecision.graph.connectpoints.ConnectPoints.get_pp">[docs]</a>    <span class="k">def</span> <span class="nf">get_pp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        ------------</span>
<span class="sd">        </span>
<span class="sd">        Get the projected point (pp) of &#39;point&#39; on &#39;line&#39;.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        </span>
<span class="sd">        Projected points</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        </span>
<span class="sd">        - point(Shapely Point object):</span>
<span class="sd">            - Point</span>
<span class="sd">        - line(Shapely LineString object):</span>
<span class="sd">            - LineString</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># project new Point to be interpolated</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">point</span><span class="p">))</span>  <span class="c1"># PP as a Point</span>
        <span class="k">return</span> <span class="n">pp</span></div>

<div class="viewcode-block" id="ConnectPoints.split_line"><a class="viewcode-back" href="../../../geodecision.graph.html#geodecision.graph.connectpoints.ConnectPoints.split_line">[docs]</a>    <span class="k">def</span> <span class="nf">split_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">pps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description</span>
<span class="sd">        ------------</span>
<span class="sd">        </span>
<span class="sd">        Split &#39;line&#39; by all intersecting &#39;pps&#39; (as multipoint)</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        </span>
<span class="sd">        New_lines (list): a list of all line segments after the split</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        </span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="sd">&quot;&quot;&quot;.</span>
<span class="sd">        Returns:</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># IMPORTANT FIX for ensuring intersection between splitters and the line</span>
        <span class="c1"># but no need for updating edges_meter manually because the old lines will be</span>
        <span class="c1"># replaced anyway</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">snap</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">pps</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">)</span>  <span class="c1"># slow?</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">pps</span><span class="p">))</span>  <span class="c1"># split into segments</span>
            <span class="k">return</span> <span class="n">new_lines</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Error when splitting line: </span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">pps</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="ConnectPoints.update_nodes"><a class="viewcode-back" href="../../../geodecision.graph.html#geodecision.graph.connectpoints.ConnectPoints.update_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">update_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">new_points</span><span class="p">,</span> <span class="n">ptype</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description:</span>
<span class="sd">        ------------</span>
<span class="sd">        Update nodes with a list (pp) or a GeoDataFrame (access) of new_points.</span>
<span class="sd">        </span>
<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        - ptype(str): </span>
<span class="sd">            - type of Point list to append, &#39;pp&#39; or &#39;access&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># create gdf of new nodes (projected PAPs)</span>
        <span class="k">if</span> <span class="n">ptype</span> <span class="o">==</span> <span class="s1">&#39;pp&#39;</span><span class="p">:</span>
            <span class="n">new_nodes</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">new_points</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span>
                                         <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_nodes</span><span class="p">)</span>
            <span class="n">new_nodes</span><span class="p">[</span><span class="s1">&#39;highway&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_highway_pp</span>
            <span class="n">new_nodes</span><span class="p">[</span><span class="s1">&#39;osmid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">osmid_prefix</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>

        <span class="c1"># create gdf of new nodes</span>
        <span class="k">elif</span> <span class="n">ptype</span> <span class="o">==</span> <span class="s1">&#39;access&#39;</span><span class="p">:</span>
            <span class="n">new_nodes</span> <span class="o">=</span> <span class="n">new_points</span><span class="p">[[</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_col</span><span class="p">]]</span>
            <span class="n">new_nodes</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;osmid&#39;</span><span class="p">]</span>
            <span class="n">new_nodes</span><span class="p">[</span><span class="s1">&#39;access_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_type</span>
            <span class="n">new_nodes</span><span class="p">[</span><span class="s1">&#39;highway&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_highway_access</span>
            <span class="n">new_nodes</span><span class="p">[</span><span class="s1">&#39;osmid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_nodes</span><span class="p">[</span><span class="s1">&#39;osmid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Unknown ptype when updating nodes.&quot;</span><span class="p">)</span>

        <span class="c1"># merge new nodes (it is safe to ignore the index for nodes)</span>
        <span class="n">gdfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">nodes</span><span class="p">,</span> <span class="n">new_nodes</span><span class="p">]</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">gdfs</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                                 <span class="n">crs</span><span class="o">=</span><span class="n">gdfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">new_nodes</span>  <span class="c1"># all nodes, newly added nodes only</span></div>

<div class="viewcode-block" id="ConnectPoints.update_edges"><a class="viewcode-back" href="../../../geodecision.graph.html#geodecision.graph.connectpoints.ConnectPoints.update_edges">[docs]</a>    <span class="k">def</span> <span class="nf">update_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">new_lines</span><span class="p">,</span> <span class="n">replace</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description:</span>
<span class="sd">        ------------</span>
<span class="sd">        </span>
<span class="sd">        Update edge info by adding new_lines; or,</span>
<span class="sd">        replace existing ones with new_lines (n-split segments).</span>
<span class="sd">        </span>
<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        - edges(DataFrame):</span>
<span class="sd">            - Edges DataFrame</span>
<span class="sd">        - new_lines(list):</span>
<span class="sd">            - list of new lines to add</span>
<span class="sd">        - replace: </span>
<span class="sd">            -treat new_lines (flat list) as newly added edges if False,</span>
<span class="sd">            else replace existing edges with new_lines (often a nested list)</span>
<span class="sd">        </span>
<span class="sd">        Note:</span>
<span class="sd">            kne_idx refers to &#39;fid in Rtree&#39;/&#39;label&#39;/&#39;loc&#39;, not positional iloc</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># for interpolation (split by pp): replicate old line</span>
        <span class="k">if</span> <span class="n">replace</span><span class="p">:</span>
            <span class="c1"># create a flattened gdf with all line segs and corresponding kne_idx</span>
            <span class="n">kne_idxs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_pps_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">lens</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">new_lines</span><span class="p">]</span>
            <span class="n">new_lines_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
                <span class="p">{</span>
                        <span class="s1">&#39;kne_idx&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
                                <span class="n">kne_idxs</span><span class="p">,</span> 
                                <span class="n">lens</span>
                                <span class="p">),</span>
                        <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span>
                                <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">new_lines</span><span class="p">)</span>
                                <span class="p">)</span>
                        <span class="p">}</span>
                <span class="p">)</span>
            <span class="c1"># merge to inherit the data of the replaced line</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">edges</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">)</span>  <span class="c1"># don&#39;t include the old geometry</span>
            <span class="n">new_edges</span> <span class="o">=</span> <span class="n">new_lines_gdf</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                    <span class="n">edges</span><span class="p">[</span><span class="n">cols</span><span class="p">],</span> 
                    <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> 
                    <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;kne_idx&#39;</span><span class="p">,</span> 
                    <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
            <span class="n">new_edges</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;kne_idx&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">new_lines</span> <span class="o">=</span> <span class="n">new_edges</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span>  <span class="c1"># now a flatten list</span>
        <span class="c1"># for connection (to external poi): append new lines</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_edges</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">key_col</span><span class="p">]],</span> 
                    <span class="n">geometry</span><span class="o">=</span><span class="n">new_lines</span><span class="p">,</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key_col</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]</span>
                    <span class="p">)</span>
            <span class="n">new_edges</span><span class="p">[</span><span class="s1">&#39;oneway&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">new_edges</span><span class="p">[</span><span class="s1">&#39;highway&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_highway</span>

        <span class="c1"># update features (a bit slow)</span>
        <span class="n">new_edges</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">length</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">new_lines</span><span class="p">]</span>
        <span class="c1">## add walkable time</span>
        <span class="n">meters_per_minute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance</span><span class="o">/</span><span class="mi">60</span>
        <span class="n">new_edges</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="n">meters_per_minute</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">new_lines</span><span class="p">]</span>
        
        <span class="n">new_edges</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_edges</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_id_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;None&#39;</span><span class="p">))</span>
        <span class="n">new_edges</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_edges</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_id_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">coords</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;None&#39;</span><span class="p">))</span>
        <span class="n">new_edges</span><span class="p">[</span><span class="s1">&#39;osmid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">new_edges</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">],</span>
                                                       <span class="n">new_edges</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">])]</span>

        <span class="c1"># remember to reindex to prevent duplication when concat</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">edges</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_edges</span><span class="p">)</span>
        <span class="n">new_edges</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>

        <span class="c1"># for interpolation: remove existing edges</span>
        <span class="k">if</span> <span class="n">replace</span><span class="p">:</span>
            <span class="n">edges</span> <span class="o">=</span> <span class="n">edges</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">kne_idxs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># for connection: filter invalid links</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#Get non-valid nodes list </span>
            <span class="c1">##(nodes not used because too far from network)        </span>
            <span class="n">non_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">new_edges</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">non_valid_nodes</span> <span class="o">=</span> <span class="n">new_edges</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">non_valid</span><span class="p">][</span><span class="s2">&quot;unique_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
            
            <span class="c1">#Get valid edges</span>
            <span class="n">valid_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">new_edges</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_edges</span><span class="p">)</span>
            <span class="n">n_fault</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_pos</span><span class="p">)</span>
            <span class="n">f_pct</span> <span class="o">=</span> <span class="n">n_fault</span> <span class="o">/</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Remove faulty projections: </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{:.2f}</span><span class="s2">%)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">n_fault</span><span class="p">,</span>
                    <span class="n">n</span><span class="p">,</span>
                    <span class="n">f_pct</span>
                    <span class="p">)</span>
            <span class="p">)</span>
            
            <span class="n">new_edges</span> <span class="o">=</span> <span class="n">new_edges</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">valid_pos</span><span class="p">]</span>  <span class="c1"># use &#39;iloc&#39; here</span>
                    

        <span class="c1"># merge new edges</span>
        <span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">edges</span><span class="p">,</span> <span class="n">new_edges</span><span class="p">]</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                                 <span class="n">crs</span><span class="o">=</span><span class="n">dfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

        <span class="c1"># all edges, newly added edges only</span>
        <span class="k">return</span> <span class="n">edges</span><span class="p">,</span> <span class="n">new_edges</span></div>
    
<div class="viewcode-block" id="ConnectPoints.process"><a class="viewcode-back" href="../../../geodecision.graph.html#geodecision.graph.connectpoints.ConnectPoints.process">[docs]</a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Description:</span>
<span class="sd">        ------------</span>
<span class="sd">        </span>
<span class="sd">        Run the complete process</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_valid_nodes</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#required to filter too far nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_nodes_process</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_edges_process</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>
        
        <span class="c1"># edges.reset_index(drop=True, inplace=True)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;osmid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;osmid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        
        <span class="c1"># report issues</span>
        <span class="c1"># - examine key duplication</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes_id_dict</span><span class="p">):</span>
            <span class="n">key_duplication</span> <span class="o">=</span> <span class="s2">&quot;NOTE: duplication in node coordinates keys&quot;</span>
            <span class="n">key_duplication</span> <span class="o">+=</span> <span class="s2">&quot;Nodes count: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
                    <span class="p">)</span>
            <span class="n">key_duplication</span> <span class="o">+=</span> <span class="s2">&quot;Node coordinates key count: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes_id_dict</span><span class="p">)</span>
                            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key_duplication</span><span class="p">)</span>
        <span class="c1"># - examine missing nodes</span>
        <span class="n">missing_nodes</span> <span class="o">=</span> <span class="s2">&quot;MISSING NODES: </span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">missing_nodes</span> <span class="o">+=</span> <span class="s2">&quot;Missing &#39;from&#39; nodes: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">])</span>
                        <span class="p">)</span>
        <span class="n">missing_nodes</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Missing &#39;target&#39; nodes: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">]</span>
                        <span class="p">)</span>
                <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">missing_nodes</span><span class="p">)</span>
        
        <span class="c1">#Remove non valid nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;osmid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">non_valid_nodes</span>
                        <span class="p">)</span>
                <span class="p">]</span>
    
        <span class="c1"># save and return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="n">nodes_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;_nodes.geojson&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">nodes_name</span><span class="p">),</span>
                    <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GeoJSON&quot;</span>
                    <span class="p">)</span>
            <span class="n">edges_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;_edges.geojson&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">edges_name</span><span class="p">),</span>
                    <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GeoJSON&quot;</span>
                    <span class="p">)</span>
        
        <span class="c1">#Log for non_valid_nodes</span>
        <span class="n">non_valid_nodes_str</span> <span class="o">=</span> <span class="s2">&quot;LIST OF NON_VALID_NODES: </span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_valid_nodes</span><span class="p">:</span>
            <span class="n">non_valid_nodes_str</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">non_valid_nodes_str</span><span class="p">)</span>
    
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_valid_nodes</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">geodecision</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html">geodecision</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">geodecision</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../authors.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../history.html">History</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Thomas Leysens.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>
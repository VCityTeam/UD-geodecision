
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>geodecision.accessibility.accessibility &#8212; geodecision 0.1.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for geodecision.accessibility.accessibility</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">#Created on Mon Sep 16 14:08:39 2019</span>
<span class="c1">#@author: thomas</span>


<span class="sd">&quot;&quot;&quot;Get Accessibility and Mask layers.</span>

<span class="sd">Usage: get_accessibility_and_mask.py [&lt;json_params&gt;]</span>

<span class="sd">  -h --help  Show this screen.</span>
<span class="sd">  -i         Parameters JSON file</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">jsonschema</span> <span class="k">import</span> <span class="n">validate</span>
<span class="c1">#from shapely.ops import cascaded_union</span>
<span class="c1">#from shapely import speedups</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">docopt</span> <span class="k">import</span> <span class="n">docopt</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>

<span class="kn">from</span> <span class="nn">..logger.logger</span> <span class="k">import</span> <span class="n">logger</span><span class="p">,</span> <span class="n">_get_duration</span>
<span class="kn">from</span> <span class="nn">.schema</span> <span class="k">import</span> <span class="n">ACCESS_SCHEMA</span>
<span class="kn">from</span> <span class="nn">.isochrone</span> <span class="k">import</span> <span class="n">Accessibility</span>
<span class="kn">from</span> <span class="nn">..graph.utils</span> <span class="k">import</span> <span class="n">graph_to_gdf_points</span><span class="p">,</span> <span class="n">df_to_graph</span>
<span class="kn">from</span> <span class="nn">..graph.splittednodes</span> <span class="k">import</span> <span class="n">GetSplitNodes</span>
<span class="kn">from</span> <span class="nn">..graph.connectpoints</span> <span class="k">import</span> <span class="n">ConnectPoints</span>
<span class="kn">from</span> <span class="nn">..spatialops.operations</span> <span class="k">import</span> <span class="n">SpatialOperations</span>

<span class="c1">#speedups.enable()</span>

<span class="c1">#Dict of results</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="erase_file"><a class="viewcode-back" href="../../../geodecision.accessibility.html#geodecision.accessibility.accessibility.erase_file">[docs]</a><span class="k">def</span> <span class="nf">erase_file</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description</span>
<span class="sd">    ------------</span>
<span class="sd">    </span>
<span class="sd">    Check if a file exists and delete it</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    </span>
<span class="sd">    None</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    </span>
<span class="sd">    - name (str):</span>
<span class="sd">        - complete path file name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="k">pass</span></div>
    
<div class="viewcode-block" id="delete_list_cols"><a class="viewcode-back" href="../../../geodecision.accessibility.html#geodecision.accessibility.accessibility.delete_list_cols">[docs]</a><span class="k">def</span> <span class="nf">delete_list_cols</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description</span>
<span class="sd">    ------------</span>
<span class="sd">    </span>
<span class="sd">    Delete columns containing lists in DataFrame or GeoDataFrame</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    </span>
<span class="sd">    New DataFrame or GeoDataFrame without columns containing lists</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    </span>
<span class="sd">    - df (DataFrame or GeoDataFra</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tmp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="nb">list</span><span class="p">))</span>
        <span class="k">if</span> <span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;tmp&quot;</span><span class="p">]:</span>
            <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span></div>
    
<div class="viewcode-block" id="write_results"><a class="viewcode-back" href="../../../geodecision.accessibility.html#geodecision.accessibility.accessibility.write_results">[docs]</a><span class="k">def</span> <span class="nf">write_results</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">output_folder</span><span class="p">,</span> <span class="n">output_format</span><span class="o">=</span><span class="s2">&quot;geopackage&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description</span>
<span class="sd">    ------------</span>
<span class="sd">    </span>
<span class="sd">    Write all the results in set format(s)</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    </span>
<span class="sd">    None</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    </span>
<span class="sd">    - results (object):</span>
<span class="sd">        - results object from Accessibility class</span>
<span class="sd">    - output_folder (str):</span>
<span class="sd">        - Path to the folder to write files</span>
<span class="sd">    - output_format (str):</span>
<span class="sd">        - format of the output files</span>
<span class="sd">        - Default: &quot;geopackage&quot;</span>
<span class="sd">        - Options: </span>
<span class="sd">            - &quot;geopackage&quot;</span>
<span class="sd">            - &quot;geojson&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">encoding</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">output_format</span> <span class="o">==</span> <span class="s2">&quot;geojson&quot;</span><span class="p">):</span>
        <span class="n">extension</span> <span class="o">=</span> <span class="s2">&quot;.geojson&quot;</span>
        <span class="n">driver</span> <span class="o">=</span> <span class="s2">&quot;GeoJSON&quot;</span>
        
        <span class="k">for</span> <span class="n">layer</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="n">output_folder</span><span class="p">,</span> 
                            <span class="nb">str</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="o">+</span> <span class="n">extension</span>
                            <span class="p">)</span>
                <span class="c1">#Delete file if already exist to avoid errors</span>
                <span class="n">erase_file</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="c1">#Delete columns containing lists before writing</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">delete_list_cols</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span>
                            <span class="n">name</span><span class="p">,</span> 
                            <span class="n">driver</span><span class="o">=</span><span class="n">driver</span><span class="p">,</span>
                            <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span>
                            <span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">cant_write</span> <span class="o">=</span> <span class="s2">&quot;CAN&#39;T WRITE FILE: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">cant_write</span><span class="p">)</span>
        
    <span class="k">elif</span> <span class="n">output_format</span> <span class="o">==</span> <span class="s2">&quot;geopackage&quot;</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="s2">&quot;output.gpkg&quot;</span><span class="p">)</span>
        <span class="c1">#Delete file if already exist to avoid errors</span>
        <span class="n">erase_file</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">layer</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">data</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span>
                    <span class="n">layer</span> <span class="o">=</span> <span class="n">layer</span><span class="p">,</span>
                    <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GPKG&quot;</span><span class="p">,</span>
                    <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span>
                    <span class="p">)</span></div>
        

<div class="viewcode-block" id="run"><a class="viewcode-back" href="../../../geodecision.accessibility.html#geodecision.accessibility.accessibility.run">[docs]</a><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">json_params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description</span>
<span class="sd">    ------------</span>
<span class="sd">    </span>
<span class="sd">    Run all the scripts based on input parameters and write output files</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    </span>
<span class="sd">    Results (object from Accessibility class)</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    </span>
<span class="sd">    - json_params (str):</span>
<span class="sd">        - Complete path file name to JSON parameters file</span>
<span class="sd">        - ex: &quot;./parameters/Lyon/test_params.json&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">start_process</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="c1">#required for log</span>
    <span class="c1">#Load params JSON file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_params</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        
    
    <span class="c1">#Set output</span>
    <span class="n">output_folder</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;output_folder&quot;</span><span class="p">]</span>
    <span class="n">output_format</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;output_format&quot;</span><span class="p">]</span>
    
    <span class="c1">#Check with schema</span>
    <span class="n">validate</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">ACCESS_SCHEMA</span><span class="p">)</span>
    
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1">#Get polygons as GeoDataFrame</span>
    <span class="n">gdf_features</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;polygons_geojsonfile&quot;</span><span class="p">])</span>
    <span class="c1">#Drop duplicates based on geometry</span>
    <span class="n">gdf_features</span> <span class="o">=</span> <span class="n">gdf_features</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;geometry&quot;</span><span class="p">)</span>
    <span class="n">gdf_features</span> <span class="o">=</span> <span class="n">gdf_features</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span>
            <span class="p">{</span>
                    <span class="s2">&quot;init&quot;</span><span class="p">:</span><span class="s2">&quot;epsg:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;epsg_metric&quot;</span><span class="p">]</span>
                            <span class="p">)</span>
                    <span class="p">}</span>
            <span class="p">)</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">                Get Polygons GeoDataFrame and project to metric:</span>
<span class="sd">                    Total time : {}</span>
<span class="sd">                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">_get_duration</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="p">)</span>
    
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1">#Split the LineStrings&#39; polygons&#39; boundaries into segments </span>
    <span class="c1"># (*with a set distance in meters*) in order to create new nodes to </span>
    <span class="c1"># generate potential connexions (*edges*) to the graph. </span>
    <span class="n">polygons_points_metric</span> <span class="o">=</span> <span class="n">GetSplitNodes</span><span class="p">(</span>
            <span class="n">gdf_features</span><span class="p">,</span> 
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;dist_split&quot;</span><span class="p">],</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;id_column&quot;</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">get_split_nodes</span><span class="p">()</span>
    
    <span class="c1">#Keep only desired columns</span>
    <span class="c1">## add &quot;unique_id&quot; to the list</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;columns_to_keep&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;unique_id&quot;</span><span class="p">)</span>
    <span class="n">polygons_points_metric</span> <span class="o">=</span> <span class="n">polygons_points_metric</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;columns_to_keep&quot;</span><span class="p">]]</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        | get_accessibility.py | </span>
<span class="sd">        | run |</span>
<span class="sd">        </span>
<span class="sd">        Splitter:</span>
<span class="sd">            Total time : {}</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">_get_duration</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
    
    <span class="c1">#Import graph from json files and transform to NetworkX MultiDiGraph</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">df_to_graph</span><span class="p">(</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;graph_edges_jsonfile&quot;</span><span class="p">],</span> 
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;graph_nodes_jsonfile&quot;</span><span class="p">]</span>
            <span class="p">)</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Import Graph:</span>
<span class="sd">                    Total time : {}</span>
<span class="sd">                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">_get_duration</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="p">)</span>
    
       
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1">#Get points and lines GeoDataFrames from Graph</span>
    <span class="n">gdf_pts</span><span class="p">,</span> <span class="n">gdf_lines</span> <span class="o">=</span> <span class="n">graph_to_gdf_points</span><span class="p">(</span>
            <span class="n">G</span><span class="p">,</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">],</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;epsg_graph&quot;</span><span class="p">],</span>
            <span class="n">get_lines</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
    <span class="c1">#To metric</span>
    <span class="n">gdf_pts_metric</span> <span class="o">=</span> <span class="n">gdf_pts</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span>
            <span class="p">{</span>
                    <span class="s2">&quot;init&quot;</span><span class="p">:</span><span class="s2">&quot;epsg:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;epsg_metric&quot;</span><span class="p">])</span>
                    <span class="p">}</span>
            <span class="p">)</span>
    <span class="n">gdf_lines_metric</span> <span class="o">=</span> <span class="n">gdf_lines</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span>
            <span class="p">{</span>
                    <span class="s2">&quot;init&quot;</span><span class="p">:</span><span class="s2">&quot;epsg:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;epsg_metric&quot;</span><span class="p">])</span>
                    <span class="p">}</span>
            <span class="p">)</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        | get_accessibility.py | </span>
<span class="sd">        | run |</span>
<span class="sd">        </span>
<span class="sd">        Get lines and points GeoDataFrames:</span>
<span class="sd">            Total time : {}</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">_get_duration</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
        
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1">#Get the updated nodes and edges (nodes from splitting polygons exterior</span>
    <span class="c1"># LineStrings)</span>
    <span class="c1">#Connexion and get updated nodes and edges</span>
    <span class="n">nodes</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">non_valid_nodes</span> <span class="o">=</span> <span class="n">ConnectPoints</span><span class="p">(</span>
            <span class="n">polygons_points_metric</span><span class="p">,</span> 
            <span class="n">gdf_pts_metric</span><span class="p">,</span> 
            <span class="n">gdf_lines_metric</span><span class="p">,</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;access_type&quot;</span><span class="p">],</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;prefix&quot;</span><span class="p">],</span>
            <span class="n">key_col</span><span class="o">=</span><span class="s2">&quot;unique_id&quot;</span><span class="p">,</span>
            <span class="n">path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">threshold</span><span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;threshold&quot;</span><span class="p">],</span> 
            <span class="n">knn</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;knn&quot;</span><span class="p">],</span>
            <span class="n">distance</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        | get_accessibility.py | </span>
<span class="sd">        | run |</span>
<span class="sd">        </span>
<span class="sd">        Make connections :</span>
<span class="sd">            Total time : {}</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">_get_duration</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
    
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1">#Measure accessibility</span>
    <span class="c1">## Get updated Graph from new edges and nodes</span>
    <span class="n">updated_G</span> <span class="o">=</span> <span class="n">df_to_graph</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;gdf&quot;</span><span class="p">)</span>
    
    <span class="c1">#TODO: remove this and write G (nodes and edges) and points, lines after update</span>
    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes</span>
    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;edges&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edges</span>
    
    <span class="c1">## Get starting nodes for isochrones</span>
    <span class="n">starting_nodes</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;access_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;access_type&quot;</span><span class="p">]</span>
            <span class="p">][</span><span class="s2">&quot;osmid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<span class="c1">#    starting_nodes = [</span>
<span class="c1">#            node for node in starting_nodes if node not in non_valid_nodes</span>
<span class="c1">#            ]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">                Get starting nodes:</span>
<span class="sd">                    Total time : {}</span>
<span class="sd">                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">_get_duration</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1">#Get accessibility</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">access</span> <span class="o">=</span> <span class="n">Accessibility</span><span class="p">(</span>
            <span class="n">updated_G</span><span class="p">,</span> 
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;trip_times&quot;</span><span class="p">],</span> 
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;distance_buffer&quot;</span><span class="p">],</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">],</span>
            <span class="n">starting_nodes</span><span class="p">,</span>
            <span class="n">gdf_features</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unary_union</span><span class="p">,</span>
            <span class="n">epsgs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;origin&quot;</span><span class="p">:</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;epsg_input&quot;</span><span class="p">],</span>
                <span class="s2">&quot;metric&quot;</span><span class="p">:</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;epsg_metric&quot;</span><span class="p">],</span>
                <span class="s2">&quot;vis&quot;</span><span class="p">:</span><span class="mi">3857</span>
                <span class="p">}</span>
            <span class="p">)</span>
    <span class="n">access</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span>
    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;updated_graph&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">access</span><span class="o">.</span><span class="n">G</span>
    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;problematic_nodes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;osmid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
                    <span class="n">access</span><span class="o">.</span><span class="n">pb_nodes</span>
                    <span class="p">)</span>
            <span class="p">]</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                | get_accessibility.py | </span>
<span class="sd">                | run |</span>
<span class="sd">        </span>
<span class="sd">                Get accessibility:</span>
<span class="sd">                    Total time : {}</span>
<span class="sd">                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">_get_duration</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="p">)</span>    
    
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1">#Add to results</span>
    <span class="c1">#TODO REMOVE COMMENT IF BUFFERED ISOLINES WITH NO UNION NEEDED</span>
    <span class="c1">##BECAUSE IT PRODUCES A REALLY HEAVY FILE NOT NECESSERALY NEEDED</span>
    <span class="n">results</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;output_isolines_layername&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">access</span><span class="o">.</span><span class="n">lines</span>
<span class="c1">#    results[</span>
<span class="c1">#            params[&quot;output_buffered_isolines_layername&quot;]</span>
<span class="c1">#            ] = access.buffered</span>
    <span class="n">results</span><span class="p">[</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;output_buffered_isolines_union_layername&quot;</span><span class="p">]</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">access</span><span class="o">.</span><span class="n">union</span>
    
    
    <span class="c1">## Spatial operations</span>
    <span class="n">dict_unions</span> <span class="o">=</span> <span class="n">SpatialOperations</span><span class="p">(</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;trip_times&quot;</span><span class="p">],</span> 
            <span class="n">gdf_features</span><span class="p">,</span> 
            <span class="n">access</span><span class="o">.</span><span class="n">union</span><span class="p">,</span>
            <span class="s2">&quot;iso_cat_merged&quot;</span><span class="p">,</span>
            <span class="n">epsg</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;epsg_metric&quot;</span><span class="p">],</span>
            <span class="n">tolerance</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;tolerance&quot;</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">dict_unions</span>
    
    <span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dict_unions</span><span class="p">)</span>        
        
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">                | get_accessibility.py | </span>
<span class="sd">                | run |</span>
<span class="sd">                </span>
<span class="sd">                Making layers:</span>
<span class="sd">                    Total time : {}</span>
<span class="sd">                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">_get_duration</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="p">)</span>    
    
    <span class="c1">#Write files</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>    
    <span class="n">write_results</span><span class="p">(</span>
            <span class="n">results</span><span class="p">,</span> 
            <span class="n">output_folder</span><span class="o">=</span><span class="n">output_folder</span><span class="p">,</span> 
            <span class="n">output_format</span><span class="o">=</span><span class="n">output_format</span>
            <span class="p">)</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">                | get_accessibility.py | </span>
<span class="sd">                | run |</span>
<span class="sd">                </span>
<span class="sd">                Writing files:</span>
<span class="sd">                    Total time : {}</span>
<span class="sd">                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">_get_duration</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="p">)</span>
                
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">                TOTAL PROCESS:</span>
<span class="sd">                    Total time : {}</span>
<span class="sd">                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">_get_duration</span><span class="p">(</span><span class="n">start_process</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="n">docopt</span><span class="p">(</span><span class="vm">__doc__</span><span class="p">)</span>
    <span class="n">json_params</span> <span class="o">=</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;&lt;json_params&gt;&quot;</span><span class="p">]</span>
    <span class="n">run</span><span class="p">(</span><span class="n">json_params</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">geodecision</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html">geodecision</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">geodecision</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../authors.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../history.html">History</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Thomas Leysens.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>